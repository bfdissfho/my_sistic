// ==UserScript==
// @name         Sistic date section quan
// @namespace    http://tampermonkey.net/
// @version      14.0
// @description  sistic
// @match        https://ticketing.sistic.com.sg/sistic/booking/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= ğŸ”§ è¨­å®šå€åŸŸ =================

    const TARGET_DATE = "22-01-2026";

    // æ ¼å¼ï¼š[ "åƒ¹æ ¼", "Section(é¸å–®æ¨¡å¼)", "SeatLevel(åœ°åœ–æ¨¡å¼)", "CatNum(åœ°åœ–æ¨¡å¼)" ]
    const PREFERENCE_LIST = [
        ["328", "SVIP Z", "Circle 1", "1"],
        ["258", "FA 14", "Circle 2", "1"],
        ["198", "FA 18", "Circle 3", "2"],
        ["158", "FA 16", "Circle 2", "4"]
    ];

    const TICKET_QUANTITY = 2;          // è³¼è²·å¼µæ•¸
    const WAIT_MINUTES_BEFORE_CART = 8; // æˆåŠŸå¾Œå€’æ•¸

    // ==============================================

    console.log("ğŸš€ Sistic V14 (è‡ªå‹•åˆ·æ–°ç‰ˆ) å•Ÿå‹•...");

    let globalOverviewData = null;
    let globalDetailsData = null;

    // --- XHR æ””æˆª ---
    const origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
        this.addEventListener('load', function() {
            try {
                if (this.responseURL) {
                    if (this.responseURL.includes('seat-map/overview')) {
                        globalOverviewData = JSON.parse(this.responseText);
                        console.log("ğŸ“¡ [Overview] æ””æˆªæˆåŠŸ");
                    }
                    if (this.responseURL.includes('seat-map/details')) {
                        globalDetailsData = JSON.parse(this.responseText);
                        console.log("ğŸ“¡ [Details] åº«å­˜æ””æˆªæˆåŠŸ");
                    }
                }
            } catch (e) {}
        });
        origOpen.apply(this, arguments);
    };

    // --- å·¥å…· ---
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function waitForElement(selector, isXpath = false, timeout = 5000) {
        return new Promise((resolve) => {
            const timer = setInterval(() => {
                let el;
                try {
                    if (isXpath) el = document.evaluate(selector, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
                    else el = document.querySelector(selector);
                } catch(e){}
                if (el && el.offsetParent !== null) {
                    clearInterval(timer);
                    resolve(el);
                }
            }, 200);
            setTimeout(() => { clearInterval(timer); resolve(null); }, timeout);
        });
    }

    async function clickPath(element) {
        if (!element) return;
        try { element.scrollIntoView({block: "center", behavior: "auto"}); } catch(e){}
        const eventOpts = { bubbles: true, cancelable: true, view: window };
        element.dispatchEvent(new MouseEvent('mousedown', eventOpts));
        element.dispatchEvent(new MouseEvent('mouseup', eventOpts));
        element.dispatchEvent(new MouseEvent('click', eventOpts));
        console.log(`âš¡ é»æ“Š Path: ${element.getAttribute('aria-label') || 'Element'}`);
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šDOM é€£çºŒåº§ä½ ---
    function findConsecutiveSeatsFromDOM(qty) {
        const allPaths = document.querySelectorAll('path.seatmap-clickable');
        console.log(`ğŸ” æƒæåˆ° ${allPaths.length} å€‹åº§ä½ Path`);

        const availableSeats = [];
        const regex = /Row\s+(.+?)\s+Seat\s+(\d+)\s+Available/i;

        allPaths.forEach(path => {
            const label = path.getAttribute('aria-label') || "";
            if (label.includes('Available')) {
                const match = label.match(regex);
                if (match) {
                    availableSeats.push({
                        element: path,
                        row: match[1].trim(),
                        seatNum: parseInt(match[2], 10),
                        label: label
                    });
                }
            }
        });

        console.log(`âœ… å…¶ä¸­ ${availableSeats.length} å€‹å¯é¸`);

        for (let i = 0; i < availableSeats.length; i++) {
            const currentSeq = [availableSeats[i]];
            for (let j = 1; j < qty; j++) {
                if (i + j >= availableSeats.length) break;
                const prev = currentSeq[j - 1];
                const next = availableSeats[i + j];
                if (next.row === prev.row && next.seatNum === prev.seatNum + 1) {
                    currentSeq.push(next);
                } else {
                    break;
                }
            }
            if (currentSeq.length === qty) {
                console.log(`ğŸ‰ æ‰¾åˆ°é€£çºŒåº§ä½ï¼ (Row ${currentSeq[0].row}: ${currentSeq.map(s=>s.seatNum).join(', ')})`);
                return currentSeq.map(s => s.element);
            }
        }
        return null;
    }

    // --- æ¨¡å¼ A ---
    async function runAutoAssignMode() {
        console.log("ğŸ”µ æ¨¡å¼ A (é¸å–®æ¨¡å¼)");
        await clickPath(document.querySelector('.choose-seat-text'));
        await sleep(1000);

        for (let pref of PREFERENCE_LIST) {
            const price = pref[0];
            const section = pref[1];
            console.log(`ğŸ”¹ å˜—è©¦: ${price} / ${section}`);

            const arrow = await waitForElement('.Select-arrow-zone', false, 3000);
            if(arrow) {
                arrow.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
                arrow.click();
            }
            await sleep(500);

            const priceOpt = await waitForElement(`//div[contains(@class, 'Select-option') and contains(., '${price}')]`, true, 3000);
            if (!priceOpt) continue;
            priceOpt.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
            priceOpt.click();
            await sleep(500);

            const secDrop = await waitForElement('.Select-placeholder', false, 3000);
            if(secDrop) {
                secDrop.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
                secDrop.click();
            }
            await sleep(500);

            const secOpt = await waitForElement(`div[aria-label="${section}"]`, false, 3000);
            if (!secOpt) {
                document.body.click();
                continue;
            }
            secOpt.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
            secOpt.click();

            await sleep(1000);
            const changePopup = document.querySelector('.alert-popup') || document.querySelector('.modal-content');
            if (changePopup && changePopup.innerText.includes('Change Selection')) {
                 const ok = document.getElementById('popup-button-0');
                 if(ok) ok.click();
            }

            if (await selectQuantityAndCheckError()) {
                await doConfirm();
                return;
            }
        }
    }

    // --- æ¨¡å¼ B ---
    async function runSeatMapMode() {
        console.log("ğŸŸ  æ¨¡å¼ B (åœ°åœ–æ¨¡å¼)");

        let waits = 0;
        while ((!globalOverviewData || !globalDetailsData) && waits < 40) {
            console.log("â³ ç­‰å¾… API...");
            await sleep(500);
            waits++;
        }

        if (!globalOverviewData) { console.error("âŒ ç„¡æ³•ç²å– API"); return; }

        let targetId = null;

        for (let pref of PREFERENCE_LIST) {
            const targetLevel = pref[2];
            const targetCatNum = pref[3];
            console.log(`ğŸ”¸ æ¯”å°: Level='${targetLevel}', CatNum='${targetCatNum}'`);

            let tempId = null;
            const list = globalOverviewData.seatSectionList;

            if (list) {
                for (let item of list) {
                    if (item.SeatLevel) {
                        for (let lvl of item.SeatLevel) {
                            if (lvl.seatLevelAlias && targetLevel &&
                                lvl.seatLevelAlias.toLowerCase() === targetLevel.toLowerCase() &&
                                String(lvl.priceCategoryNum) === String(targetCatNum)) {
                                tempId = lvl.seatSectionId;
                                break;
                            }
                        }
                    }
                    if (tempId) break;
                }
            }

            if (!tempId) {
                console.log(`âŒ æ‰¾ä¸åˆ° IDï¼Œè·³é`);
                continue;
            }

            if (globalDetailsData) {
                const detail = globalDetailsData.find(d => d.seatSectionId == tempId);
                if (detail && detail.seatSectionAvailability === 0) {
                    console.warn(`ğŸ›‘ ID [${tempId}] åº«å­˜ç‚º 0ï¼Œè·³é`);
                    continue;
                }
            }

            targetId = tempId;
            console.log(`ğŸ¯ é–å®š ID: ${targetId}`);
            break;
        }

        if (!targetId) { alert("âŒ ç„¡ç¬¦åˆå€å¡Šæˆ–å·²å”®ç½„"); return; }

        const area = await waitForElement(`area[id="${targetId}"]`, false, 5000);
        if (area) {
            await clickPath(area);
        } else {
            return;
        }

        console.log("â³ ç­‰å¾… SVG åº§ä½åœ–æ¸²æŸ“...");

        let domWaits = 0;
        let foundPaths = false;
        while (domWaits < 40) {
            const paths = document.querySelectorAll('path.seatmap-clickable');
            if (paths.length > 0) {
                foundPaths = true;
                break;
            }
            await sleep(250);
            domWaits++;
        }

        if (!foundPaths) {
            console.error("âŒ è¶…æ™‚ï¼šSVG åœ°åœ–æœªæ¸²æŸ“æˆ–ç„¡å¯é¸åº§ä½");
            return;
        }

        const targetPathElements = findConsecutiveSeatsFromDOM(TICKET_QUANTITY);

        if (targetPathElements) {
            console.log("ğŸ’º é»æ“Šé€£çºŒåº§ä½...");
            for (let el of targetPathElements) {
                await clickPath(el);
                await sleep(150);
            }

            await sleep(500);
            const confirmBtn = await waitForElement('.confirm-btn');
            if(confirmBtn) {
                 let attempts = 0;
                 while ((confirmBtn.disabled || confirmBtn.classList.contains('disabled')) && attempts < 20) {
                     await sleep(200); attempts++;
                 }
                 confirmBtn.click();
                 console.log("âœ… å·²é»æ“Š Confirm");
                 startCountdown();
            }
        } else {
            alert("âš ï¸ æƒæå®Œç•¢ï¼Œæœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é€£çºŒåº§ä½");
        }
    }

    // --- è¼”åŠ©é‚è¼¯ ---

    async function selectQuantityAndCheckError() {
        let qtyContainer = document.getElementById('react-select-8--value-item');
        if (!qtyContainer) {
             const zeroSpan = await waitForElement("//div[contains(@class, 'Select-value')]//span[text()='0']", true, 2000);
             if(zeroSpan) qtyContainer = zeroSpan.closest('.Select-control');
        } else {
             qtyContainer = qtyContainer.closest('.Select-control');
        }

        if (qtyContainer) {
             qtyContainer.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
             qtyContainer.click();
             await sleep(500);
             const qtyNum = await waitForElement(`div[aria-label="${TICKET_QUANTITY}"]`);
             if(qtyNum) {
                 qtyNum.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
                 qtyNum.click();
             }
        } else return false;

        await sleep(1000);
        const err = document.querySelector('.notify-popup');
        if (err && err.innerText.includes('Insufficient')) {
            const ok = document.getElementById('popup-button-0');
            if(ok) ok.click();
            return false;
        }
        return true;
    }

    async function doConfirm() {
        console.log("â³ ç­‰å¾… Confirm...");
        await sleep(1000);
        const btn = await waitForElement('.confirm-btn');
        if (!btn) return;

        let i = 0;
        while ((btn.disabled || btn.classList.contains('disabled')) && i < 30) {
            await sleep(200); i++;
        }
        btn.click();

        await sleep(2000);
        const err = document.querySelector('.notify-popup');
        if (err && err.innerText.includes('Insufficient')) {
             const ok = document.getElementById('popup-button-0');
             if(ok) ok.click();
             return;
        }
        startCountdown();
    }

    function startCountdown() {
        console.log(`ğŸ›‘ æˆåŠŸ! å€’æ•¸ ${WAIT_MINUTES_BEFORE_CART} åˆ†é˜`);
        const target = new Date().getTime() + (WAIT_MINUTES_BEFORE_CART * 60000);
        const t = setInterval(() => {
            const d = target - new Date().getTime();
            if (d < 0) {
                clearInterval(t);
                const btn = document.getElementById('bs-btn-atc-id');
                if(btn) btn.click();
            } else {
                console.log(`â° å‰©é¤˜ ${(d/1000).toFixed(0)} ç§’`);
            }
        }, 1000);
    }

    // --- ä¸»æµç¨‹ ---
    window.addEventListener('load', async function() {
        await sleep(1500);

        const dateEl = await waitForElement(`td[title="${TARGET_DATE}"] a`, false, 3000);
        if (dateEl) {
            console.log("ğŸ“… è™•ç†æ—¥æœŸ...");
            await clickPath(dateEl);

            const ck = await waitForElement('.checkmark', false, 3000);
            if (ck) {
                await clickPath(ck);

                // ğŸ”¥ æ–°å¢ï¼šç›£æ§æ˜¯å¦æœ‰éŒ¯èª¤å½ˆçª— (occur / occurs) ğŸ”¥
                console.log("â³ ç›£æ§éŒ¯èª¤è¦–çª— (5ç§’)...");
                for(let i=0; i<10; i++) { // æª¢æŸ¥ 10 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 0.5 ç§’ = 5ç§’
                    const modal = document.querySelector('.notification-modal') || document.querySelector('.notify-popup') || document.querySelector('.modal-content');
                    if (modal) {
                        const text = modal.innerText.toLowerCase();
                        if (text.includes('ocurr')) { // æ¶µè“‹ occur, occurred, occurs
                            console.warn("âš ï¸ åµæ¸¬åˆ° 'occur' éŒ¯èª¤ï¼Œç«‹å³åˆ·æ–°ï¼");
                            location.reload();
                            return; // çµ‚æ­¢è…³æœ¬
                        }
                    }
                    await sleep(500);
                }
            }
        }

        console.log("â“ åˆ¤æ–·æ¨¡å¼...");
        // å¢åŠ ç­‰å¾…æ™‚é–“ï¼Œç¢ºä¿æ—¥æœŸé é¢è½‰å ´å®Œæˆ
        const chooseBtn = await waitForElement('.choose-seat-text', false, 5000);

        if (chooseBtn) {
            await runAutoAssignMode();
        } else {
            await runSeatMapMode();
        }
    });

})();
